{% load static %}
<!doctype html>
<html lang="en">

{% include "head.html" %}

<body>

  {% include "nav.html" %}

  <div class="hero">
    <div class="container">
      <div class="row justify-content-between">
        <div class="col-lg-5">
          <div class="intro-excerpt">
            <h1>Checkout</h1>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="untree_co-section">
    <div class="container">
      <div class="row mb-5">
        <div class="col-md-12">
          <div class="border p-4 rounded" role="alert">
            Returning customer? <a href="#">Click here</a> to login
          </div>
        </div>
      </div>
      <form method="post" action="{% url 'paiement_om' %}" id="checkout-form">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-6 mb-5 mb-md-0">
            <h2 class="h3 mb-3 text-black">Billing Details</h2>
            <div class="p-3 p-lg-5 border bg-white">
              <div class="form-group">
                <label for="c_country" class="text-black">Country <span class="text-danger">*</span></label>
                <select id="c_country" name="country" class="form-control">
                  <option value="">Select a country</option>
                  <option value="CI">Côte d'Ivoire</option>
                  <option value="FR">France</option>
                  <option value="US">USA</option>
                </select>
              </div>
              <div class="form-group row">
                <div class="col-md-6">
                  <label for="c_fname" class="text-black">First Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="c_fname" name="first_name" required>
                </div>
                <div class="col-md-6">
                  <label for="c_lname" class="text-black">Last Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="c_lname" name="last_name" required>
                </div>
              </div>
              <div class="form-group">
                <label for="c_address" class="text-black">Address <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="c_address" name="address" required>
              </div>
              <div class="form-group">
                <label for="c_email_address" class="text-black">Email Address <span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="c_email_address" name="email" required>
              </div>
              <div class="form-group">
                <label for="c_phone" class="text-black">Phone</label>
                <input type="text" class="form-control" id="c_phone" name="phone">
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <h2 class="h3 mb-3 text-black">Your Order</h2>
            <div class="p-3 p-lg-5 border bg-white">
              <div id="order-summary">
                <p class="text-muted">Chargement des produits du panier...</p>
              </div>
              <div class="form-group mt-4">
                <label for="telephone" class="form-label">Numéro Orange Money</label>
                <input type="text" class="form-control" name="telephone" id="telephone" placeholder="Ex: 2250700000000" required>
              </div>
              <input type="hidden" name="prix_total" id="prix_total_input" value="0">
              <div class="form-group mt-4">
                <button type="submit" class="btn btn-warning btn-lg py-3 btn-block">Payer avec Orange Money</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% include "footer.html" %}
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'js/tiny-slider.js' %}"></script>
  <script src="{% static 'js/custom.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      fetch("{% url 'api_cart_items' %}")
        .then(response => response.json())
        .then(data => {
          const orderSummary = document.getElementById("order-summary");
          const prixTotalInput = document.getElementById("prix_total_input");
          if (data.items && data.items.length > 0) {
            let html = '<table class="table site-block-order-table mb-5">';
            html += '<thead><tr><th>Product</th><th>Total</th></tr></thead><tbody>';
            let total = 0;
            data.items.forEach(item => {
              const sousTotal = item.prix * item.quantite;
              total += sousTotal;
              html += `<tr><td>
                          <input type="hidden" name="produits" value="${item.id}-${item.quantite}">
                          ${item.nom} <strong class="mx-2">x</strong> ${item.quantite}</td>
                          <td>$${sousTotal.toFixed(2)}</td></tr>`;
            });
            html += `<tr><td class="text-black font-weight-bold"><strong>Order Total</strong></td>
                      <td class="text-black font-weight-bold"><strong>$${total.toFixed(2)}</strong></td></tr>`;
            html += '</tbody></table>';
            orderSummary.innerHTML = html;
            prixTotalInput.value = total.toFixed(2);
          } else {
            orderSummary.innerHTML = '<p class="text-danger">Aucun produit dans votre panier.</p>';
          }
        })
        .catch(error => {
          console.error("Erreur lors du chargement du panier:", error);
          document.getElementById("order-summary").innerHTML = '<p class="text-danger">Erreur de chargement du panier.</p>';
        });
    });
  </script>
</body>
</html>