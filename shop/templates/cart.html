{% load static %}
<!doctype html>
<html lang="en">
  {% include "head.html" %}

<body>
  {% include "nav.html" %}

  <div class="hero">
    <div class="container">
      <div class="row justify-content-between">
        <div class="col-lg-5">
          <div class="intro-excerpt">
            <h1>Cart</h1>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="untree_co-section before-footer-section">
    <div class="container">
      <form method="post">
        {% csrf_token %}
        <div class="site-blocks-table">
          <table class="table">
            <thead>
              <tr>
                <th class="product-thumbnail">Image</th>
                <th class="product-name">Product</th>
                <th class="product-price">Price</th>
                <th class="product-quantity">Quantity</th>
                <th class="product-total">Total</th>
                <th class="product-remove">Remove</th>
              </tr>
            </thead>
            <tbody>
              {% for item in produits %}
              <tr>
                <td class="product-thumbnail">
                  {% if item.produit.image_produit %}
                  <img src="{{ item.produit.image_produit.url }}" alt="{{ item.produit.nom_produit }}" class="img-fluid">
                  {% else %}
                  <img src="{% static 'images/default-product.jpg' %}" alt="Image par dÃ©faut" class="img-fluid">
                  {% endif %}
                </td>
                <td class="product-name">
                  <h2 class="h5 text-black">{{ item.produit.nom_produit }}</h2>
                </td>
                <td>${{ item.produit.prix }}</td>
                <td>
                  <div class="input-group mb-3 d-flex align-items-center quantity-container" style="max-width: 120px;">
                    <div class="input-group-prepend">
                      <button class="btn btn-outline-black decrease" type="button">&minus;</button>
                    </div>
                    <input type="text" class="form-control text-center quantity-amount" value="{{ item.quantite }}" data-product-id="{{ item.produit.id }}" aria-label="Quantity">
                    <div class="input-group-append">
                      <button class="btn btn-outline-black increase" type="button">&plus;</button>
                    </div>
                  </div>
                </td>
                <td class="product-total">${{ item.sous_total|floatformat:2 }}</td>
                <td>
                  <a href="{% url 'remove_from_cart' item.produit.id %}" class="btn btn-black btn-sm">X</a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6">Votre panier est vide.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>
      <div class="row">
        <div class="col-md-6">
          <button class="btn btn-outline-black btn-sm btn-block" onclick="window.location='{% url 'shop' %}'">Continue Shopping</button>
        </div>
        <div class="col-md-6 pl-5">
          <div class="row justify-content-end">
            <div class="col-md-7">
              <div class="row">
                <div class="col-md-12 text-right border-bottom mb-5">
                  <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <span class="text-black">Subtotal</span>
                </div>
                <div class="col-md-6 text-right">
                  <strong class="text-black cart-total">${{ total }}</strong>
                </div>
              </div>
              <div class="row mb-5">
                <div class="col-md-6">
                  <span class="text-black">Total</span>
                </div>
                <div class="col-md-6 text-right">
                  <strong class="text-black cart-total">${{ total }}</strong>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <form method="get" action="{% url 'checkout' %}">
                    <button type="submit" class="btn btn-black btn-lg py-3 btn-block">Acheter maintenant</button>
                  </form>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include "footer.html" %}

  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'js/tiny-slider.js' %}"></script>
  <script src="{% static 'js/custom.js' %}"></script>

  <script>
    const updateCartQuantityUrl = "{% url 'update_cart_quantity' %}";
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", function(){
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function updateQuantity(productId, newQuantity, quantityInput) {
      fetch(updateCartQuantityUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: new URLSearchParams({
          'product_id': productId,
          'quantity': newQuantity
        })
      })
      .then(response => response.json())
      .then(data => {
        if (!data.error) {
          const row = quantityInput.closest("tr");
          const lineTotalCell = row.querySelector(".product-total");
          if (lineTotalCell) {
            lineTotalCell.textContent = "$" + data.line_total.toFixed(2);
          }
          document.querySelectorAll(".cart-total").forEach(elem => {
            elem.textContent = "$" + data.cart_total.toFixed(2);
          });
        } else {
          alert("Error updating quantity: " + data.error);
        }
      })
      .catch(err => console.error("Erreur updateQuantity:", err));
    }

    document.querySelectorAll(".btn.increase").forEach(function(button) {
      button.addEventListener("click", function() {
        const quantityInput = this.closest(".input-group").querySelector(".quantity-amount");
        let currentQuantity = parseInt(quantityInput.value, 10);
        if (isNaN(currentQuantity)) {
          currentQuantity = 0;
        }
        currentQuantity += 1;
        quantityInput.value = currentQuantity;
        const productId = quantityInput.getAttribute("data-product-id");
        updateQuantity(productId, currentQuantity, quantityInput);
      });
    });

    document.querySelectorAll(".btn.decrease").forEach(function(button) {
      button.addEventListener("click", function() {
        const quantityInput = this.closest(".input-group").querySelector(".quantity-amount");
        let currentQuantity = parseInt(quantityInput.value, 10);
        if (isNaN(currentQuantity) || currentQuantity <= 0) {
          currentQuantity = 0;
        }
        if (currentQuantity > 1) {
          currentQuantity -= 1;
          quantityInput.value = currentQuantity;
          const productId = quantityInput.getAttribute("data-product-id");
          updateQuantity(productId, currentQuantity, quantityInput);
        }
      });
    });
  });
  </script>
</body>
</html>
