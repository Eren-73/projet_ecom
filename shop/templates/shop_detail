{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5 shop-detail">
  <div class="row">
    <!-- Image du produit -->
    <div class="col-md-6">
      {% if produit.image_produit %}
        <img src="{{ produit.image_produit.url }}" alt="{{ produit.nom_produit }}" class="img-fluid rounded">
      {% else %}
        <img src="{% static 'images/default-product.jpg' %}" alt="Image par défaut" class="img-fluid rounded">
      {% endif %}
    </div>

    <!-- Détails du produit -->
    <div class="col-md-6">
      <h1 class="mb-3">{{ produit.nom_produit }}</h1>
      <p class="h4 text-primary" id="prix-unitaire" data-price="{{ produit.prix }}">${{ produit.prix }}</p>
      <p class="product-description my-4">{{ produit.description }}</p>

      <!-- Formulaire d'ajout au panier avec gestion de la quantité -->
      <form method="post" action="{% url 'add_to_cart' produit.id %}">
        {% csrf_token %}
        <div class="form-group d-flex align-items-center mb-3">
          <label for="quantity" class="me-2">Quantité :</label>
          <button type="button" class="btn btn-outline-secondary me-2" id="decrease">–</button>
          <input type="number" name="quantity" id="quantity" value="1" min="1" class="form-control text-center w-25">
          <button type="button" class="btn btn-outline-secondary ms-2" id="increase">+</button>
        </div>
        <p class="mt-3">Total : <span id="total-price" class="fw-bold">${{ produit.prix }}</span></p>
        <button type="submit" class="btn btn-primary mt-3">Ajouter au Panier</button>
      </form>
    </div>
  </div>

  <hr class="my-5">

  <!-- Description Complète -->
  <div class="row">
    <div class="col-12">
      <h2>Description Complète</h2>
      <p>{{ produit.description }}</p>
    </div>
  </div>

  <!-- Produits Similaires -->
  <div class="row my-5">
    <div class="col-12">
      <h2 class="section-title">Produits Similaires</h2>
      <div class="d-flex flex-wrap justify-content-between">
        {% for p in produits_similaires %}
          <div class="similar-product m-2" style="width: 30%;">
            <a href="{% url 'produit_detail' p.id %}" class="text-decoration-none">
              {% if p.image_produit %}
                <img src="{{ p.image_produit.url }}" alt="{{ p.nom_produit }}" class="img-fluid rounded">
              {% else %}
                <img src="{% static 'images/default-product.jpg' %}" alt="Image par défaut" class="img-fluid rounded">
              {% endif %}
              <h5 class="mt-2">{{ p.nom_produit }}</h5>
              <p>${{ p.prix }}</p>
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("DOM chargé, script exécuté.");
  const quantityInput = document.getElementById("quantity");
  const priceElement = document.getElementById("prix-unitaire");
  const totalElement = document.getElementById("total-price");
  const btnPlus = document.getElementById("increase");
  const btnMinus = document.getElementById("decrease");

  if (!quantityInput || !priceElement || !totalElement || !btnPlus || !btnMinus) {
    console.error("Un des éléments du DOM est manquant.");
    return;
  }

  // Récupère le prix unitaire depuis l'attribut data-price et vérifie que c'est bien un nombre
  const unitPrice = parseFloat(priceElement.dataset.price);
  if (isNaN(unitPrice)) {
    console.error("Le prix unitaire n'est pas un nombre valide.");
    return;
  }

  // Fonction pour mettre à jour le total en fonction de la quantité
  function updateTotal() {
    const quantity = parseInt(quantityInput.value) || 1;
    const total = (quantity * unitPrice).toFixed(2);
    totalElement.textContent = `$${total}`;
  }

  // Incrémente la quantité
  btnPlus.addEventListener("click", function() {
    let currentQty = parseInt(quantityInput.value) || 1;
    quantityInput.value = currentQty + 1;
    updateTotal();
  });

  // Décrémente la quantité (ne descend pas en dessous de 1)
  btnMinus.addEventListener("click", function() {
    let currentQty = parseInt(quantityInput.value) || 1;
    if (currentQty > 1) {
      quantityInput.value = currentQty - 1;
      updateTotal();
    }
  });

  // Mise à jour en temps réel lors du changement manuel de la quantité
  quantityInput.addEventListener("input", function() {
    let value = parseInt(this.value);
    if (isNaN(value) || value < 1) {
      this.value = 1;
    }
    updateTotal();
  });
});
</script>
{% endblock %}
